{% extends "base.html" %}

{% block title %}Reservas{% endblock %}

{% block content %}
<div class="dashboard-container">
  <h1 class="page-title">Gesti√≥n de Reservas</h1>
  <a href="{{ url_for('dashboard.index') }}" class="back-link">‚¨ÖÔ∏è Volver</a>

  <!-- Formulario estilo card -->
  <div class="form-card">
    <h3>‚ûï Nueva Reserva</h3>
    <form method="post" action="{{ url_for('reservas.crear_reserva') }}" class="reserva-form">
      <div class="form-row">
        <!-- üëâ Autocompletado de clientes -->
        <div class="form-group" style="position: relative; flex: 1;">
          <input type="text" id="identificacion" name="identificacion" 
                 placeholder="Identificaci√≥n Cliente" autocomplete="off" required>
          <input type="hidden" id="idcliente" name="idcliente">
          <span id="cliente-msg" class="cliente-msg"></span>
          <ul id="sugerencias" class="sugerencias-list"></ul>
        </div>

        <select name="idproducto" id="producto-select" required onchange="setPrecio()">
          <option value="">-- Selecciona producto --</option>
          {% for p in productos %}
            <option value="{{ p.idproducto }}" data-precio="{{ p.precio }}">{{ p.nombre }}</option>
          {% endfor %}
        </select>

        <input type="number" step="0.01" id="valor" name="valor" placeholder="Valor Total" required>
      </div>

      <div class="form-row">
        <select name="idmedio" required>
          <option value="">-- Selecciona medio de pago --</option>
          {% for m in medios %}
            <option value="{{ m.idmedio }}">{{ m.nombre }}</option>
          {% endfor %}
        </select>

        <select name="estado" required>
          <option value="RESERVADO">Reservado</option>
          <option value="FACTURADO">Facturado</option>
          <option value="CANCELADO">Cancelado</option>
        </select>

        <button type="submit" class="btn-success">üíæ Guardar</button>
      </div>
    </form>
  </div>

  <hr>

  <!-- üîé Formulario de b√∫squeda -->
  <div class="filter-card">
    <h3>üìÖ Buscar Reservas por Fecha</h3>
    <form method="get" action="{{ url_for('reservas.listar_reservas') }}" class="filter-form">
      <div class="form-row">
        <div class="form-group">
          <label for="fecha_inicio">Desde:</label>
          <input type="date" id="fecha_inicio" name="fecha_inicio"
                 value="{{ request.args.get('fecha_inicio','') }}">
        </div>
        <div class="form-group">
          <label for="fecha_fin">Hasta:</label>
          <input type="date" id="fecha_fin" name="fecha_fin"
                 value="{{ request.args.get('fecha_fin','') }}">
        </div>
        <div class="form-actions">
          <button type="submit" class="btn-success">üîç Buscar</button>
          <a href="{{ url_for('reservas.listar_reservas') }}" class="btn-secondary">‚ùå Limpiar</a>
        </div>
      </div>
    </form>
  </div>

  <hr>

  <!-- Listado de reservas -->
  <h2>üìã Listado de Reservas</h2>
  <table class="styled-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Fecha</th>
        <th>Cliente</th>
        <th>Producto</th>
        <th>Valor</th>
        <th>Medio</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody>
      {% if reservas %}
        {% for r in reservas %}
        <tr>
          <td>{{ r.id }}</td>
          <td>{{ r.fecha }}</td>
          <td>{{ r.cliente }}</td>
          <td>{{ r.producto }}</td>
          <td>${{ "{:,.2f}".format(r.valor|float) }}</td>
          <td>{{ r.medio }}</td>
          <td>
            {% if r.estado == "RESERVADO" %}
              <span class="badge badge-yellow">üïí {{ r.estado }}</span>
            {% elif r.estado == "FACTURADO" %}
              <span class="badge badge-green">üí∞ {{ r.estado }}</span>
            {% elif r.estado == "CANCELADO" %}
              <span class="badge badge-red">‚ùå {{ r.estado }}</span>
            {% else %}
              {{ r.estado }}
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="7" style="text-align: center;">No hay reservas registradas</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Script para autocompletar -->
<script>
  function setPrecio() {
    const select = document.getElementById("producto-select");
    const precio = select.options[select.selectedIndex]?.getAttribute("data-precio");
    document.getElementById("valor").value = precio || "";
  }

  const inputIdentificacion = document.getElementById("identificacion");
  const hiddenIdCliente = document.getElementById("idcliente");
  const msg = document.getElementById("cliente-msg");
  const sugerencias = document.getElementById("sugerencias");

  // Buscar clientes mientras escribe
  inputIdentificacion.addEventListener("input", async function() {
    const valor = this.value.trim();
    msg.textContent = "";
    hiddenIdCliente.value = "";
    sugerencias.innerHTML = "";

    if (valor.length < 3) return;

    try {
      const resp = await fetch(`/reservas/clientes?identificacion=${valor}`);
      const data = await resp.json();

        if (data.length > 0) {
          sugerencias.innerHTML = data.map(c => 
            `<li data-id="${c.idcliente}" data-nombre="${c.nombrecompleto || ''}">
              <strong>${c.identificacion}</strong> - ${c.nombrecompleto || ''}
            </li>`).join("");
        }
    } catch (err) {
      console.error("‚ùå Error buscando clientes:", err);
    }
  });

  // Seleccionar cliente
    sugerencias.addEventListener("click", function(e) {
      if (e.target.closest("li")) {
        const li = e.target.closest("li");
        const id = li.getAttribute("data-id");
        const nombre = li.getAttribute("data-nombre");
        const identificacion = li.textContent.split(" - ")[0];

        hiddenIdCliente.value = id;
        inputIdentificacion.value = `${identificacion} - ${nombre}`; // üëà mostramos los dos
        msg.textContent = "‚úÖ Cliente seleccionado: " + nombre;
        msg.className = "cliente-msg ok";

        sugerencias.innerHTML = "";
      }
    });

  inputIdentificacion.addEventListener("blur", () => {
    setTimeout(() => { sugerencias.innerHTML = ""; }, 200);
  });
</script>

{% endblock %}
