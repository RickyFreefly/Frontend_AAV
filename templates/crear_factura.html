{% extends "base.html" %}

{% block title %}Nueva Factura{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/facturas.css') }}">
<div class="form-container dark-card">
  <h2 class="section-title">üßæ Crear Factura</h2>
  <a href="{{ url_for('facturas.listar_facturas') }}" class="back-link">‚¨ÖÔ∏è Volver</a>



<!-- Selector de modo mejorado -->
<div class="mode-switch">
  <label class="mode-option">
    <input type="radio" name="modo" value="manual" checked onclick="toggleModo('manual')">
    <span>Crear manualmente</span>
  </label>
  <label class="mode-option">
    <input type="radio" name="modo" value="reserva" onclick="toggleModo('reserva')">
    <span>Desde una reserva</span>
  </label>
</div>

  <form method="post" action="{{ url_for('facturas.crear_factura') }}" class="styled-form" onsubmit="return validarSaldo()">

    <!-- üîπ Cliente -->
    <div class="card-section">
      <h3 class="form-section-title">üë§ Cliente</h3>
      <div id="manual-section">
        <div class="form-grid-2">
          <input type="text" id="buscarIdentificacion" placeholder="Ingrese identificaci√≥n">
          <button type="button" class="btn-secondary" onclick="buscarCliente()">üîç Buscar</button>
        </div>
        <div id="cliente-info" class="info-box"></div>
        <input type="hidden" id="idcliente" name="idcliente">
      </div>

      <div id="reserva-section" style="display:none;">
        <div class="form-grid-2">
          <input type="text" id="identificacion" placeholder="Identificaci√≥n Cliente">
          <button type="button" class="btn-secondary" onclick="cargarReserva()">üîç Buscar Reserva</button>
        </div>
        <div id="reserva-info" class="info-box"></div>
        <input type="hidden" id="idreserva" name="idreserva">
      </div>
    </div>

    <!-- üîπ Observaciones -->
    <div class="card-section">
      <h3 class="form-section-title">üìù Observaciones</h3>
      <textarea id="observaciones" name="observaciones" placeholder="Notas adicionales..."></textarea>
    </div>

    <!-- üîπ Detalles -->
    <div class="card-section">
      <h3 class="form-section-title">üõí Detalles de la Factura</h3>
      <div id="detalles" class="dynamic-list"></div>
      <button type="button" class="btn-secondary" onclick="addDetalle()">‚ûï Agregar Detalle</button>
    </div>

    <!-- üîπ Pagos -->
    <div class="card-section">
      <h3 class="form-section-title">üí≥ Pagos</h3>
      <div id="pagos" class="dynamic-list"></div>
      <button type="button" class="btn-secondary" onclick="addPago()">‚ûï Agregar Pago</button>
    </div>

    <!-- üîπ Totales estilo dashboard -->
    <div class="card-section">
      <h3 class="form-section-title">üìä Totales</h3>
      <div class="totales-grid">
        <div class="total-card azul">
          <h4>Total Factura</h4>
          <p id="totalFactura">0.00</p>
        </div>
        <div class="total-card verde">
          <h4>Total Pagado</h4>
          <p id="totalPagado">0.00</p>
        </div>
        <div class="total-card rojo" id="saldoCard">
          <h4>Saldo Pendiente</h4>
          <p id="saldoPendiente">0.00</p>
        </div>
      </div>
      <p id="mensaje-saldo" class="saldo-warning" style="display:none;">
        ‚ö†Ô∏è El saldo pendiente debe ser 0 para guardar la factura.
      </p>
    </div>

    <!-- Bot√≥n -->
    <div class="form-actions">
      <button type="submit" id="btnGuardar" class="btn-primary">üíæ Guardar Factura</button>
    </div>
  </form>
</div>

<script>
let productos = [];
let medios = [];
let detalleIndex = 0;
let pagoIndex = 0;

function toggleModo(modo) {
  document.getElementById('reserva-section').style.display = (modo === 'reserva') ? 'block' : 'none';
  document.getElementById('manual-section').style.display = (modo === 'manual') ? 'block' : 'none';
}

async function cargarProductosYMedios() {
  try {
    const respProd = await fetch("/facturas/buscar_productos");
    if (respProd.ok) productos = await respProd.json();
    const respMedios = await fetch("/facturas/buscar_medios");
    if (respMedios.ok) medios = await respMedios.json();
    addDetalle();
    addPago();
  } catch (err) {
    console.error("‚ùå Error cargando cat√°logos:", err);
  }
}

async function buscarCliente() {
  const identificacion = document.getElementById("buscarIdentificacion").value;
  if (!identificacion) return alert("Ingrese identificaci√≥n");
  try {
    const resp = await fetch(`/facturas/buscar_cliente?identificacion=${identificacion}`);
    if (!resp.ok) throw new Error("Cliente no encontrado");
    const clientes = await resp.json();
    if (!clientes.length) throw new Error("Cliente no encontrado");
    const cliente = clientes[0];
    document.getElementById("cliente-info").innerHTML = `<p><strong>Nombre:</strong> ${cliente.nombrecompleto}</p><p><strong>Email:</strong> ${cliente.email || 'N/A'}</p>`;
    document.getElementById("idcliente").value = cliente.idcliente;
  } catch (err) { alert("Error buscando cliente: " + err.message); }
}

async function cargarReserva() {
  const identificacion = document.getElementById("identificacion").value;
  if (!identificacion) return alert("Ingrese la identificaci√≥n del cliente");

  try {
    const resp = await fetch(`http://localhost:3000/api/reservas/cliente/${identificacion}`);
    if (!resp.ok) throw new Error("Reserva no encontrada");
    const reservas = await resp.json();
    const reserva = reservas[0];

    // Mostrar info
    document.getElementById("reserva-info").innerHTML = `
      <p><strong>Identificaci√≥n:</strong> ${reserva.identificacion}</p>
      <p><strong>Cliente:</strong> ${reserva.nombre_cliente}</p>
      <p><strong>Email:</strong> ${reserva.email}</p>
      <p><strong>Tel√©fono:</strong> ${reserva.telefono}</p>
      <p><strong>Producto:</strong> ${reserva.producto}</p>
      <p><strong>Precio:</strong> ${reserva.precio}</p>
      <p><strong>Valor Abono:</strong> ${reserva.abono}</p>
      <p><strong>Medio:</strong> ${reserva.medio}</p>`;

    // Hidden necesarios para el backend
    document.getElementById("idreserva").value = reserva.id;
    document.getElementById("idcliente").value = reserva.idcliente;

    // Observaciones
    document.getElementById("observaciones").value =
      "Factura generada desde reserva del cliente " + reserva.identificacion;

    // Detalle: incluye el HIDDEN con idproducto (¬°lo importante!)
    document.getElementById("detalles").innerHTML = `
      <div class="detalle-row form-grid-4" id="detalle_0">
        <input type="hidden" name="detalles[0][idproducto]" value="${reserva.idproducto}">
        <input type="text" value="${reserva.producto}" readonly>
        <input type="number" name="detalles[0][cantidad]" value="1" readonly>
        <input type="number" step="0.01" name="detalles[0][valorunitario]" id="valor_0" value="${reserva.precio}" readonly>
      </div>`;

    // Pago: incluye HIDDEN con idmedio
    document.getElementById("pagos").innerHTML = `
      <div class="pago-row form-grid-4" id="pago_0">
        <input type="hidden" name="pagos[0][idmedio]" value="${reserva.idmedio}">
        <input type="text" value="${reserva.medio}" readonly>
        <input type="number" step="0.01" name="pagos[0][valor]" value="${reserva.abono}" readonly>
        <input type="date" name="pagos[0][due_date]" value="${new Date().toISOString().split('T')[0]}" readonly>
      </div>`;

    // IMPORTANTE: avanza los √≠ndices para evitar colisi√≥n al agregar nuevas filas
    detalleIndex = 1;
    pagoIndex = 1;

    // Totales iniciales
    actualizarTotales();
  } catch (err) {
    alert("Error cargando reserva: " + err.message);
  }
}

function addDetalle() {
  const div = document.createElement('div');
  div.classList.add("detalle-row", "form-grid-4");
  div.setAttribute("id", `detalle_${detalleIndex}`);

  let options = '<option value="">-- Selecciona producto --</option>';
  productos.forEach(p => options += `<option value="${p.idproducto}" data-precio="${p.precio}">${p.nombre}</option>`);

  div.innerHTML = `
    <select name="detalles[${detalleIndex}][idproducto]" onchange="setPrecio(this, ${detalleIndex})" required>${options}</select>
    <input type="number" name="detalles[${detalleIndex}][cantidad]" value="1" min="1" oninput="actualizarSubtotal(${detalleIndex})" required>
    <input type="number" step="0.01" name="detalles[${detalleIndex}][valorunitario]" id="valor_${detalleIndex}" readonly required>
    <button type="button" class="btn-delete" onclick="eliminarDetalle(${detalleIndex})">‚ùå</button>
  `;
  document.getElementById("detalles").appendChild(div);
  detalleIndex++;
}

function eliminarDetalle(index) {
  const row = document.getElementById(`detalle_${index}`);
  if (row) row.remove();
  actualizarTotales();
}

function setPrecio(selectElem, index) {
  const precio = selectElem.options[selectElem.selectedIndex].dataset.precio || 0;
  const valorInput = document.querySelector(`#valor_${index}`);
  valorInput.dataset.unitario = precio;
  valorInput.value = precio;
  actualizarSubtotal(index);
}

function actualizarSubtotal(index) {
  const cantidad = parseFloat(document.querySelector(`input[name="detalles[${index}][cantidad]"]`).value) || 1;
  const valorInput = document.querySelector(`#valor_${index}`);
  const precioUnitario = parseFloat(valorInput.dataset.unitario || 0);
  valorInput.value = (precioUnitario * cantidad).toFixed(2);
  actualizarTotales();
}

function addPago() {
  const div = document.createElement('div');
  div.classList.add("pago-row", "form-grid-4");
  div.setAttribute("id", `pago_${pagoIndex}`);

  let options = '<option value="">-- Selecciona medio --</option>';
  medios.forEach(m => options += `<option value="${m.idmedio}">${m.nombre}</option>`);

  div.innerHTML = `
    <select name="pagos[${pagoIndex}][idmedio]" required>${options}</select>
    <input type="number" step="0.01" name="pagos[${pagoIndex}][valor]" placeholder="Valor Pago" oninput="actualizarTotales()" required>
    <input type="date" name="pagos[${pagoIndex}][due_date]" required>
    <button type="button" class="btn-delete" onclick="eliminarPago(${pagoIndex})">‚ùå</button>
  `;
  document.getElementById("pagos").appendChild(div);
  pagoIndex++;
}

function eliminarPago(index) {
  const row = document.getElementById(`pago_${index}`);
  if (row) row.remove();
  actualizarTotales();
}

function actualizarTotales() {
  let total = 0;
  document.querySelectorAll("[id^=valor_], input[name*='[valorunitario]']").forEach(input => {
    total += parseFloat(input.value) || 0;
  });
  document.getElementById("totalFactura").innerText = total.toFixed(2);

  let pagado = 0;
  document.querySelectorAll(".pago-row input[name*='[valor]']").forEach(input => {
    pagado += parseFloat(input.value) || 0;
  });
  document.getElementById("totalPagado").innerText = pagado.toFixed(2);

  const saldo = total - pagado;
  const saldoElem = document.getElementById("saldoPendiente");
  saldoElem.innerText = saldo.toFixed(2);

  const saldoCard = document.getElementById("saldoCard");
  const mensaje = document.getElementById("mensaje-saldo");
  const btnGuardar = document.getElementById("btnGuardar");

  if (saldo !== 0) {
    mensaje.style.display = "block";
    saldoCard.classList.add("rojo");
    saldoCard.classList.remove("verde");
    btnGuardar.disabled = true;
  } else {
    mensaje.style.display = "none";
    saldoCard.classList.add("verde");
    saldoCard.classList.remove("rojo");
    btnGuardar.disabled = false;
  }
}

function validarSaldo() {
  const saldo = parseFloat(document.getElementById("saldoPendiente").innerText) || 0;
  return saldo === 0;
}

document.addEventListener("DOMContentLoaded", cargarProductosYMedios);
</script>
{% endblock %}
