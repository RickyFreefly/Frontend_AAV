{% extends "base.html" %}
{% block title %}Nueva Factura{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/facturas.css') }}">

<!-- Select2 para b√∫squeda avanzada -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<div class="form-container dark-card">
  <h2 class="section-title">üßæ Crear Factura</h2>
  <a href="{{ url_for('facturas.listar_facturas') }}" class="back-link">‚¨ÖÔ∏è Volver</a>

  <!-- Selector de modo -->
  <div class="mode-switch">
    <label class="mode-option">
      <input type="radio" name="modo" value="manual"
             {% if not reserva %}checked{% endif %}
             onclick="toggleModo('manual')">
      <span>Crear manualmente</span>
    </label>
    <label class="mode-option">
      <input type="radio" name="modo" value="reserva"
             {% if reserva %}checked{% endif %}
             onclick="toggleModo('reserva')">
      <span>Desde una reserva</span>
    </label>
  </div>

  <!-- FORMULARIO -->
  <form method="post" action="{{ url_for('facturas.crear_factura') }}" 
        class="styled-form" onsubmit="return validarSaldo()">

    <!-- üë§ CLIENTE -->
    <div class="card-section">
      <h3 class="form-section-title">üë§ Cliente</h3>

      <!-- Manual -->
      <div id="manual-section" style="{% if reserva %}display:none{% endif %}">
        <div class="form-grid-2">
          <input type="text" id="buscarIdentificacion" 
                 placeholder="Ingrese identificaci√≥n"
                 value="{{ identificacion or (cliente.identificacion if cliente) or '' }}">
          <button type="button" class="btn-secondary" onclick="buscarCliente()">üîç Buscar</button>
        </div>
        <div id="cliente-info" class="info-box">
          {% if cliente %}
            <p><strong>Nombre:</strong> {{ cliente.nombres }} {{ cliente.apellidos }}</p>
            <p><strong>Email:</strong> {{ cliente.email or 'N/A' }}</p>
          {% endif %}
        </div>
        <input type="hidden" id="idcliente" name="idcliente" 
               value="{{ idCliente or (cliente.idcliente if cliente) or '' }}">
      </div>

      <!-- Desde reserva -->
      <div id="reserva-section" style="{% if not reserva %}display:none{% endif %}">
        <div class="form-grid-2">
          <input type="text" id="identificacion" placeholder="Identificaci√≥n Cliente"
                 value="{{ reserva.identificacion if reserva else '' }}">
          <button type="button" class="btn-secondary" onclick="cargarReserva()">üîç Buscar Reserva</button>
        </div>

        {% if reserva %}
        <div id="reserva-info" class="info-box">
          <p><strong>Cliente:</strong> {{ reserva.nombre_cliente }}</p>
          <p><strong>Producto:</strong> {{ reserva.producto }}</p>
          <p><strong>Valor:</strong> ${{ "{:,.2f}".format(reserva.precio) }}</p>
          <p><strong>Abono:</strong> ${{ "{:,.2f}".format(reserva.abono) }}</p>
          <p><strong>Medio:</strong> {{ reserva.medio }}</p>
        </div>
        {% endif %}

        <input type="hidden" id="idreserva" name="idreserva" value="{{ idReserva or (reserva.id if reserva) or '' }}">
        <input type="hidden" id="idcliente" name="idcliente" value="{{ idCliente or (reserva.idcliente if reserva) or '' }}">
      </div>
    </div>

    <!-- üìù OBSERVACIONES -->
    <div class="card-section">
      <h3 class="form-section-title">üìù Observaciones</h3>
      <textarea id="observaciones" name="observaciones" placeholder="Notas adicionales...">
        {% if reserva %}Factura generada desde reserva del cliente {{ reserva.identificacion }}{% endif %}
      </textarea>
    </div>

    <!-- üõí DETALLES -->
    <div class="card-section">
      <h3 class="form-section-title">üõí Detalles de la Factura</h3>
      <div id="detalles" class="dynamic-list">
        {% if reserva %}
          <div class="detalle-row form-grid-4" id="detalle_0">
            <input type="hidden" name="detalles[0][idproducto]" value="{{ reserva.idproducto }}">
            <input type="text" value="{{ reserva.producto }}" readonly>
            <input type="number" name="detalles[0][cantidad]" value="1" readonly>
            <input type="number" step="0.01" name="detalles[0][valorunitario]" id="valor_0" 
                   value="{{ reserva.precio }}" readonly>
          </div>
        {% endif %}
      </div>
      <button type="button" class="btn-secondary" onclick="addDetalle()">‚ûï Agregar Detalle</button>
    </div>

    <!-- üí≥ PAGOS -->
    <div class="card-section">
      <h3 class="form-section-title">üí≥ Pagos</h3>
      <div id="pagos" class="dynamic-list">
        {% if reserva %}
          <div class="pago-row form-grid-4" id="pago_0">
            <input type="hidden" name="pagos[0][idmedio]" value="{{ reserva.idmedio }}">
            <input type="text" value="{{ reserva.medio }}" readonly>
            <input type="number" step="0.01" name="pagos[0][valor]" value="{{ reserva.abono }}" readonly>
            <input type="date" name="pagos[0][due_date]" value="{{ datetime.now().strftime('%Y-%m-%d') }}" readonly>
          </div>
        {% endif %}
      </div>
      <button type="button" class="btn-secondary" onclick="addPago()">‚ûï Agregar Pago</button>
    </div>

    <!-- üìä TOTALES -->
    <div class="card-section">
      <h3 class="form-section-title">üìä Totales</h3>
      <div class="totales-grid">
        <div class="total-card azul">
          <h4>Total Factura</h4>
          <p id="totalFactura">{{ "{:,.2f}".format(reserva.precio) if reserva else "0.00" }}</p>
        </div>
        <div class="total-card verde">
          <h4>Total Pagado</h4>
          <p id="totalPagado">{{ "{:,.2f}".format(reserva.abono) if reserva else "0.00" }}</p>
        </div>
        <div class="total-card rojo" id="saldoCard">
          <h4>Saldo Pendiente</h4>
          <p id="saldoPendiente">
            {% if reserva %}
              {{ "{:,.2f}".format(reserva.precio - reserva.abono) }}
            {% else %}
              0.00
            {% endif %}
          </p>
        </div>
      </div>
      <p id="mensaje-saldo" class="saldo-warning" style="display:none;">
        ‚ö†Ô∏è El saldo pendiente debe ser 0 para guardar la factura.
      </p>
    </div>

    <!-- üíæ GUARDAR -->
    <div class="form-actions">
      <button type="submit" id="btnGuardar" class="btn-primary">üíæ Guardar Factura</button>
    </div>
  </form>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
let productos = [];
let medios = [];
let detalleIndex = 1;
let pagoIndex = 1;

function toggleModo(modo) {
  document.getElementById('reserva-section').style.display = (modo === 'reserva') ? 'block' : 'none';
  document.getElementById('manual-section').style.display = (modo === 'manual') ? 'block' : 'none';
}

async function cargarProductosYMedios() {
  try {
    const respProd = await fetch("/facturas/buscar_productos");
    if (respProd.ok) productos = await respProd.json();
    const respMedios = await fetch("/facturas/buscar_medios");
    if (respMedios.ok) medios = await respMedios.json();

    {% if not reserva %}
      addDetalle();
      addPago();
    {% endif %}
  } catch (err) {
    console.error("‚ùå Error cargando cat√°logos:", err);
  }
}

function addDetalle() {
  const div = document.createElement('div');
  div.classList.add("detalle-row", "form-grid-4");
  div.setAttribute("id", `detalle_${detalleIndex}`);

  // Opciones con c√≥digo y nombre
  let options = '<option value="">-- Selecciona producto --</option>';
  productos.forEach(p => options += `<option value="${p.idproducto}" data-precio="${p.precio}">${p.codigo} ‚Äî ${p.nombre}</option>`);

  div.innerHTML = `
    <select class="producto-select" name="detalles[${detalleIndex}][idproducto]" onchange="setPrecio(this, ${detalleIndex})" required>${options}</select>
    <input type="number" name="detalles[${detalleIndex}][cantidad]" value="1" min="1" oninput="actualizarSubtotal(${detalleIndex})" required>
    <input type="number" step="0.01" name="detalles[${detalleIndex}][valorunitario]" id="valor_${detalleIndex}" oninput="actualizarTotales()" required>
    <button type="button" class="btn-delete" onclick="eliminarDetalle(${detalleIndex})">‚ùå</button>
  `;
  document.getElementById("detalles").appendChild(div);

  // Inicializar Select2 en el nuevo select
  $(`#detalle_${detalleIndex} .producto-select`).select2({
    placeholder: 'Buscar producto por c√≥digo o nombre...',
    allowClear: true,
    width: '100%'
  });

  detalleIndex++;
}

function eliminarDetalle(index) {
  const row = document.getElementById(`detalle_${index}`);
  if (row) row.remove();
  actualizarTotales();
}

function setPrecio(selectElem, index) {
  const precio = selectElem.options[selectElem.selectedIndex].dataset.precio || 0;
  const valorInput = document.querySelector(`#valor_${index}`);
  valorInput.value = precio;
  valorInput.dataset.unitario = precio;
  actualizarSubtotal(index);
}

function actualizarSubtotal(index) {
  const cantidad = parseFloat(document.querySelector(`input[name="detalles[${index}][cantidad]"]`).value) || 1;
  const valorInput = document.querySelector(`#valor_${index}`);
  const precioUnitario = parseFloat(valorInput.dataset.unitario || 0);
  valorInput.value = (precioUnitario * cantidad).toFixed(2);
  actualizarTotales();
}

function addPago() {
  const div = document.createElement('div');
  div.classList.add("pago-row", "form-grid-4");
  div.setAttribute("id", `pago_${pagoIndex}`);
  let options = '<option value="">-- Selecciona medio --</option>';
  medios.forEach(m => options += `<option value="${m.idmedio}">${m.nombre}</option>`);
  div.innerHTML = `
    <select name="pagos[${pagoIndex}][idmedio]" required>${options}</select>
    <input type="number" step="0.01" name="pagos[${pagoIndex}][valor]" placeholder="Valor Pago" oninput="actualizarTotales()" required>
    <input type="date" name="pagos[${pagoIndex}][due_date]" value="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
    <button type="button" class="btn-delete" onclick="eliminarPago(${pagoIndex})">‚ùå</button>
  `;
  document.getElementById("pagos").appendChild(div);
  pagoIndex++;
}

function eliminarPago(index) {
  const row = document.getElementById(`pago_${index}`);
  if (row) row.remove();
  actualizarTotales();
}

function actualizarTotales() {
  let total = 0;
  document.querySelectorAll("[id^=valor_]").forEach(input => total += parseFloat(input.value) || 0);
  document.getElementById("totalFactura").innerText = total.toFixed(2);
  let pagado = 0;
  document.querySelectorAll(".pago-row input[name*='[valor]']").forEach(input => pagado += parseFloat(input.value) || 0);
  document.getElementById("totalPagado").innerText = pagado.toFixed(2);
  const saldo = total - pagado;
  document.getElementById("saldoPendiente").innerText = saldo.toFixed(2);
  const mensaje = document.getElementById("mensaje-saldo");
  const btnGuardar = document.getElementById("btnGuardar");
  if (saldo !== 0) {
    mensaje.style.display = "block";
    btnGuardar.disabled = true;
  } else {
    mensaje.style.display = "none";
    btnGuardar.disabled = false;
  }
}

function validarSaldo() {
  const saldo = parseFloat(document.getElementById("saldoPendiente").innerText) || 0;
  return saldo === 0;
}

document.addEventListener("DOMContentLoaded", cargarProductosYMedios);
</script>
{% endblock %}
