{% extends "base.html" %}
{% block title %}Clientes{% endblock %}

{% block content %}
<div class="dashboard-container">
  <h1 class="page-title">üìã Gesti√≥n de Clientes</h1>
  <a href="{{ url_for('dashboard.index') }}" class="btn-volver">‚¨ÖÔ∏è Volver</a>

  <!-- ========================= FORMULARIO CREAR CLIENTE ========================= -->
  <div class="card">
    <h2>‚ûï Crear Cliente</h2>
    <form method="post" action="{{ url_for('clientes.crear_cliente') }}" class="cliente-form" id="clienteForm">
      <input type="hidden" name="id_type" id="id_type">

      <!-- Tipo de Cliente -->
      <div class="form-row">
        <div class="form-group">
          <label>Tipo de Cliente</label>
          <select name="tipo" id="tipo" onchange="ajustarFormulario()" required>
            <option value="NATURAL">Natural</option>
            <option value="JURIDICA">Jur√≠dica</option>
          </select>
        </div>
      </div>

      <!-- Tipo y N√∫mero de Identificaci√≥n -->
      <div class="form-row">
        <div class="form-group">
          <label>Tipo de Identificaci√≥n</label>
          <select id="tipo_identificacion_select" name="tipo_identificacion" required>
            <option value="11">Registro Civil</option>
            <option value="12">Tarjeta de Identidad</option>
            <option value="13" selected>C√©dula de Ciudadan√≠a</option>
            <option value="21">Tarjeta de Extranjer√≠a</option>
            <option value="22">C√©dula de Extranjer√≠a</option>
            <option value="31">NIT</option>
            <option value="41">Pasaporte</option>
            <option value="42">Sin identificaci√≥n del exterior</option>
          </select>
        </div>

        <div class="form-group">
          <label>N√∫mero de Identificaci√≥n</label>
          <div class="input-with-dv">
            <input type="text" name="identificacion" required>
            <span class="dv-field juridica" style="display:none;">
              -
              <input type="text" name="check_digit" maxlength="2" pattern="[0-9]{1,2}" title="M√°ximo 2 d√≠gitos">
            </span>
          </div>
        </div>
      </div>

      <!-- NATURAL -->
      <div class="natural">
        <div class="form-row">
          <div class="form-group">
            <label>Nombres</label>
            <input type="text" name="nombres" style="text-transform: uppercase;">
          </div>
          <div class="form-group">
            <label>Apellidos</label>
            <input type="text" name="apellidos" style="text-transform: uppercase;">
          </div>
        </div>
      </div>

      <!-- JURIDICA -->
      <div class="juridica" style="display:none;">
        <div class="form-row">
          <div class="form-group">
            <label>Raz√≥n Social</label>
            <input type="text" name="razonSocial" style="text-transform: uppercase;">
          </div>
        </div>
      </div>

      <!-- COMUNES -->
      <div class="form-row">
        <div class="form-group">
          <label>Direcci√≥n</label>
          <input type="text" name="direccion" style="text-transform: uppercase;">
        </div>
        <div class="form-group">
          <label>Tel√©fono</label>
          <input type="text" name="telefono">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Correo electr√≥nico</label>
          <input type="email" name="contact_email" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group full-width">
          <label>Observaciones</label>
          <textarea name="observacion" rows="3" style="text-transform: uppercase;"></textarea>
        </div>
      </div>

      <div class="form-row">
        <button type="submit" class="btn-primary">üíæ Guardar</button>
      </div>
    </form>
  </div>

  <!-- ========================= BUSCADOR ========================= -->
  <div class="card">
    <h2>üîé Buscar Cliente</h2>
    <form method="get" action="{{ url_for('clientes.listar_clientes') }}">
      <div class="form-row">
        <input type="text" name="identificacion" placeholder="Ingrese identificaci√≥n..."
               value="{{ request.args.get('identificacion', '') }}">
        <button type="submit" class="btn-primary">Buscar</button>
      </div>
    </form>
  </div>

  <!-- ========================= LISTADO DE CLIENTES ========================= -->
  <div class="card">
    <h2>üìë Listado de Clientes</h2>
    <div style="overflow-x:auto;">
      <table class="styled-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Tipo</th>
            <th>Identificaci√≥n</th>
            <th>Nombre / Raz√≥n Social</th>
            <th>Direcci√≥n</th>
            <th>Tel√©fono</th>
            <th>Email</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for c in clientes %}
          <tr>
            <td>{{ c.idcliente }}</td>
            <td><span class="badge-tipo {{ c.tipo_local }}">{{ c.tipo_local }}</span></td>
            <td>
              {% if c.tipo_local == "JURIDICA" %}
                NIT {{ c.identificacion }}{% if c.check_digit %}-{{ c.check_digit }}{% endif %}
              {% else %}
                CC {{ c.identificacion }}
              {% endif %}
            </td>
            <td style="text-transform: uppercase;">
              {% if c.tipo_local == "JURIDICA" %}
                {{ c.razonsocial }}
              {% else %}
                {{ c.nombres }} {{ c.apellidos }}
              {% endif %}
            </td>
            <td>{{ c.direccion or '-' }}</td>
            <td>{{ c.telefono or '-' }}</td>
            <td>
              {% if c.contact_email %}
                <a href="mailto:{{ c.contact_email }}" class="email-link">{{ c.contact_email }}</a>
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              <div class="acciones-flex">
                <a href="{{ url_for('clientes.editar_cliente_form', idCliente=c.idcliente) }}" 
                   class="btn-icon editar" title="Editar">‚úèÔ∏è</a>

                <!-- üîπ Enviamos tambi√©n la identificaci√≥n del cliente -->
                <a href="{{ url_for('reservas.crear_reserva_form', 
                                    idCliente=c.idcliente, 
                                    identificacion=c.identificacion) }}" 
                   class="btn-icon reserva" title="Crear Reserva">‚ûï</a>

                <a href="{{ url_for('facturas.crear_factura_form', 
                                    idCliente=c.idcliente, 
                                    identificacion=c.identificacion) }}" 
                   class="btn-icon factura" title="Crear Factura">üßæ</a>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="empty">‚ö†Ô∏è No hay clientes registrados</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ========================= PAGINACI√ìN ========================= -->
    {% if total_pages > 1 %}
    <div class="pagination">
      {% if page > 1 %}
      <a href="{{ url_for('clientes.listar_clientes', page=page-1, identificacion=request.args.get('identificacion', '')) }}" class="page-link">‚¨ÖÔ∏è Anterior</a>
      {% endif %}

      {% for p in range(1, total_pages + 1) %}
      {% if p == page %}
      <span class="page-current">{{ p }}</span>
      {% else %}
      <a href="{{ url_for('clientes.listar_clientes', page=p, identificacion=request.args.get('identificacion', '')) }}" class="page-link">{{ p }}</a>
      {% endif %}
      {% endfor %}

      {% if page < total_pages %}
      <a href="{{ url_for('clientes.listar_clientes', page=page+1, identificacion=request.args.get('identificacion', '')) }}" class="page-link">Siguiente ‚û°Ô∏è</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- ========================= SCRIPT ========================= -->
<script>
function ajustarFormulario() {
  const tipo = document.getElementById("tipo").value;
  const naturalFields = document.querySelectorAll(".natural");
  const juridicaFields = document.querySelectorAll(".juridica");
  const idType = document.getElementById("id_type");
  const tipoSelect = document.getElementById("tipo_identificacion_select");
  const dvField = document.querySelectorAll(".dv-field");

  if (tipo === "NATURAL") {
    naturalFields.forEach(f => f.style.display = "block");
    juridicaFields.forEach(f => f.style.display = "none");
    dvField.forEach(f => f.style.display = "none");
    tipoSelect.disabled = false;
    tipoSelect.value = "13";
  } else {
    naturalFields.forEach(f => f.style.display = "none");
    juridicaFields.forEach(f => f.style.display = "block");
    dvField.forEach(f => f.style.display = "flex");
    tipoSelect.value = "31";
    tipoSelect.disabled = true;
  }
  idType.value = tipoSelect.value;
}

document.addEventListener("DOMContentLoaded", () => {
  ajustarFormulario();
  document.getElementById("tipo_identificacion_select").addEventListener("change", e => {
    document.getElementById("id_type").value = e.target.value;
  });
  document.getElementById("tipo").addEventListener("change", ajustarFormulario);
});
</script>

<!-- ========================= ESTILOS ========================= -->
<style>
.dashboard-container { max-width: 1200px; margin:auto; padding:20px; }
.card { background:#fff; border-radius:12px; padding:25px; margin-top:20px; box-shadow:0 3px 10px rgba(0,0,0,0.05); border:1px solid #e3e6ea; }

.page-title { text-align:center; font-weight:700; color:#2c3e50; }

.btn-volver { background:#6c757d; color:#fff; padding:8px 14px; border-radius:6px; text-decoration:none; font-weight:bold; }
.btn-volver:hover { background:#5a6268; }

.styled-table { width:100%; border-collapse:separate; border-spacing:0; background:#fff; border-radius:10px; overflow:hidden; font-size:14px; }
.styled-table thead { background:linear-gradient(90deg,#007bff,#0056b3); color:white; }
.styled-table th, .styled-table td { padding:12px 14px; border-bottom:1px solid #e5e8ef; text-align:left; }
.styled-table tr:hover { background-color:#f8faff; }

.badge-tipo { padding:4px 8px; border-radius:8px; font-size:0.8rem; font-weight:600; color:#fff; }
.badge-tipo.NATURAL { background:#6c63ff; }
.badge-tipo.JURIDICA { background:#00b894; }

.acciones-flex { display:flex; justify-content:center; gap:6px; }
.btn-icon { display:inline-flex; align-items:center; justify-content:center; width:30px; height:30px; border-radius:50%; color:#fff; font-size:0.9rem; text-decoration:none; transition:transform 0.2s; }
.btn-icon:hover { transform:scale(1.1); }
.btn-icon.editar { background:#ffc107; }
.btn-icon.reserva { background:#28a745; }
.btn-icon.factura { background:#17a2b8; }

.email-link { color:#007bff; text-decoration:none; }
.email-link:hover { text-decoration:underline; }

.pagination { display:flex; justify-content:center; gap:8px; margin-top:15px; }
.page-link, .page-current { padding:6px 12px; border-radius:6px; border:1px solid #ccc; }
.page-link:hover { background:#007bff; color:white; border-color:#007bff; }
.page-current { background:#007bff; color:white; font-weight:bold; }
.empty { text-align:center; color:#666; padding:10px; font-style:italic; }
</style>
{% endblock %}
